<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ona Hotels - C√°lculo Ahorro Iluminaci√≥n LED (TER030)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Paleta de colores corporativa Ona Hotels */
    :root {
      --ona-teal-dark: #006B7D;
      --ona-teal: #008B9C;
      --ona-teal-light: #00A8BD;
      --ona-teal-lighter: #E0F4F7;
      --ona-white: #FFFFFF;
      --ona-grey-light: #F8F9FA;
      --ona-grey: #E9ECEF;
      --ona-grey-dark: #6C757D;
      --ona-text: #212529;
      --ona-border: #DEE2E6;
      --ona-success: #28A745;
      --ona-warning: #FFC107;
    }

    * { box-sizing: border-box; }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; 
      padding: 0;
      background: linear-gradient(135deg, var(--ona-grey-light) 0%, var(--ona-grey) 100%);
      color: var(--ona-text);
    }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header con logo */
    header { 
      background: var(--ona-white);
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 107, 125, 0.08);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 25px;
      flex-wrap: wrap;
    }

    header .header-content {
      flex: 1;
    }

    header h1 { 
      margin: 0 0 6px 0; 
      font-size: 24px; 
      font-weight: 600;
      color: var(--ona-teal-dark);
      line-height: 1.3;
    }

    header .subtitle {
      font-size: 13px;
      color: var(--ona-grey-dark);
      margin: 0;
      line-height: 1.4;
    }

    header img { 
      height: 55px; 
      border-radius: 6px;
      flex-shrink: 0;
    }

    /* Tarjetas */
    .card { 
      background: var(--ona-white);
      padding: 24px 28px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 107, 125, 0.08);
      border: 1px solid var(--ona-border);
      margin-bottom: 25px;
    }

    .card h2 { 
      margin: 0 0 18px 0; 
      font-size: 18px;
      font-weight: 600;
      color: var(--ona-teal-dark);
      border-bottom: 2px solid var(--ona-teal-light);
      padding-bottom: 8px;
    }

    .card h3 {
      margin: 20px 0 12px 0;
      font-size: 15px;
      font-weight: 600;
      color: var(--ona-teal);
    }

    /* Formulario */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      color: var(--ona-text);
      margin-bottom: 6px;
    }

    label .unit {
      font-weight: 400;
      color: var(--ona-grey-dark);
      font-size: 12px;
    }

    input, select {
      padding: 10px 12px;
      border: 1px solid var(--ona-border);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--ona-teal);
      box-shadow: 0 0 0 3px var(--ona-teal-lighter);
    }

    /* Tabla */
    table { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 13px;
      margin: 15px 0;
    }

    thead {
      background: var(--ona-teal-dark);
      color: var(--ona-white);
    }

    th { 
      padding: 12px 10px; 
      text-align: left; 
      font-weight: 600;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    td { 
      padding: 10px; 
      border: 1px solid var(--ona-border);
    }

    tbody tr:nth-child(even) {
      background: var(--ona-grey-light);
    }

    tbody tr:hover {
      background: var(--ona-teal-lighter);
    }

    td input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--ona-border);
      border-radius: 4px;
      font-size: 13px;
    }

    .btn-remove {
      background: #DC3545;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: background 0.2s;
    }

    .btn-remove:hover {
      background: #C82333;
    }

    /* Botones */
    .btn {
      padding: 11px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--ona-teal);
      color: white;
    }

    .btn-primary:hover {
      background: var(--ona-teal-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 139, 156, 0.3);
    }

    .btn-secondary {
      background: var(--ona-grey);
      color: var(--ona-text);
    }

    .btn-secondary:hover {
      background: var(--ona-border);
    }

    .btn-export {
      background: var(--ona-success);
      color: white;
    }

    .btn-export:hover {
      background: #218838;
    }

    .btn-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    /* Resumen de resultados */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }

    .summary-item {
      background: linear-gradient(135deg, var(--ona-teal-light) 0%, var(--ona-teal) 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 139, 156, 0.2);
    }

    .summary-item.warning {
      background: linear-gradient(135deg, #FFD54F 0%, var(--ona-warning) 100%);
      color: var(--ona-text);
    }

    .summary-item.success {
      background: linear-gradient(135deg, #66BB6A 0%, var(--ona-success) 100%);
    }

    .summary-label {
      font-size: 12px;
      font-weight: 500;
      opacity: 0.95;
      margin-bottom: 6px;
    }

    .summary-value {
      font-size: 28px;
      font-weight: 700;
      line-height: 1.2;
    }

    .summary-unit {
      font-size: 14px;
      font-weight: 400;
      opacity: 0.9;
    }

    /* Gr√°ficos */
    .chart-container {
      position: relative;
      height: 350px;
      margin: 20px 0;
    }

    /* Metodolog√≠a */
    .methodology {
      background: var(--ona-grey-light);
      padding: 16px 20px;
      border-radius: 8px;
      border-left: 4px solid var(--ona-teal);
      margin: 20px 0;
      font-size: 13px;
      line-height: 1.6;
    }

    .methodology strong {
      color: var(--ona-teal-dark);
    }

    .formula {
      background: white;
      padding: 12px 16px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      margin: 10px 0;
      text-align: center;
      font-size: 14px;
      border: 1px solid var(--ona-border);
    }

    /* Referencias normativas */
    .reference {
      background: var(--ona-teal-lighter);
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 12px;
      margin: 15px 0;
      border-left: 3px solid var(--ona-teal);
    }

    .reference strong {
      color: var(--ona-teal-dark);
    }

    /* Responsive */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        text-align: center;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .summary-grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 11px;
      }

      th, td {
        padding: 8px 6px;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <header>
      <div class="header-content">
        <h1>C√°lculo de Ahorro Energ√©tico - Iluminaci√≥n LED</h1>
        <p class="subtitle">Ficha TER030: Sustituci√≥n del sistema de iluminaci√≥n por LED | Sector Terciario</p>
      </div>
      <img src="https://agi-prod-file-upload-public-main-use1.s3.amazonaws.com/b806f497-fbe0-4b2d-9354-245962d5b1a4" alt="Ona Hotels" />
    </header>

    <!-- Par√°metros generales -->
    <div class="card">
      <h2>üìã Par√°metros Generales</h2>
      
      <div class="reference">
        <strong>Normativa aplicable:</strong> Ficha TER030 - Sustituci√≥n del sistema de iluminaci√≥n por sistema con fuentes luminosas y/o luminarias tipo LED
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="buildingType">Tipo de edificio <span class="unit">(determina horas de uso)</span></label>
          <select id="buildingType">
            <option value="5000" selected>Hoteles (5.000 h/a√±o)</option>
            <option value="2500">Oficinas (2.500 h/a√±o)</option>
            <option value="2000">Edificios educativos (2.000 h/a√±o)</option>
            <option value="5000_hospital">Hospitales (5.000 h/a√±o)</option>
            <option value="2500_rest">Restaurantes (2.500 h/a√±o)</option>
            <option value="4000_sport">Instalaciones deportivas (4.000 h/a√±o)</option>
            <option value="5000_retail">Comercio mayorista/minorista (5.000 h/a√±o)</option>
            <option value="4000_industry">Industrias de fabricaci√≥n (4.000 h/a√±o)</option>
            <option value="custom">Personalizado</option>
          </select>
        </div>

        <div class="form-group">
          <label for="hoursPerYear">Horas de funcionamiento anuales <span class="unit">(h/a√±o)</span></label>
          <input type="number" id="hoursPerYear" value="5000" min="0" step="100" />
        </div>

        <div class="form-group">
          <label for="electricityPrice">Precio electricidad <span class="unit">(‚Ç¨/kWh)</span></label>
          <input type="number" id="electricityPrice" value="0.15" min="0" step="0.01" />
        </div>

        <div class="form-group">
          <label for="co2Factor">Factor CO‚ÇÇ <span class="unit">(kg CO‚ÇÇ/kWh)</span></label>
          <input type="number" id="co2Factor" value="0.30" min="0" step="0.01" />
        </div>
      </div>
    </div>

    <!-- Tabla de luminarias -->
    <div class="card">
      <h2>üí° Luminarias Sustituidas</h2>
      
      <div style="overflow-x: auto;">
        <table id="lightsTable">
          <thead>
            <tr>
              <th style="width: 40px;">#</th>
              <th style="min-width: 150px;">Ubicaci√≥n</th>
              <th style="min-width: 100px;">Tipo Anterior</th>
              <th style="min-width: 90px;">Potencia Ant. (W)</th>
              <th style="min-width: 80px;">Cantidad Ant.</th>
              <th style="min-width: 100px;">Tipo Nuevo LED</th>
              <th style="min-width: 90px;">Potencia LED (W)</th>
              <th style="min-width: 80px;">Cantidad LED</th>
              <th style="width: 80px;">Acciones</th>
            </tr>
          </thead>
          <tbody id="lightsTableBody">
            <tr>
              <td>1</td>
              <td><input type="text" value="Pasillo planta 1" class="location" /></td>
              <td><input type="text" value="Fluorescente T8" class="oldType" /></td>
              <td><input type="number" value="36" min="0" class="oldPower" /></td>
              <td><input type="number" value="20" min="1" class="oldQty" /></td>
              <td><input type="text" value="Tubo LED T8" class="newType" /></td>
              <td><input type="number" value="18" min="0" class="newPower" /></td>
              <td><input type="number" value="20" min="1" class="newQty" /></td>
              <td><button class="btn-remove" onclick="removeRow(this)">Eliminar</button></td>
            </tr>
            <tr>
              <td>2</td>
              <td><input type="text" value="Habitaciones (50 uds)" class="location" /></td>
              <td><input type="text" value="Hal√≥geno" class="oldType" /></td>
              <td><input type="number" value="50" min="0" class="oldPower" /></td>
              <td><input type="number" value="200" min="1" class="oldQty" /></td>
              <td><input type="text" value="LED GU10" class="newType" /></td>
              <td><input type="number" value="6" min="0" class="newPower" /></td>
              <td><input type="number" value="200" min="1" class="newQty" /></td>
              <td><button class="btn-remove" onclick="removeRow(this)">Eliminar</button></td>
            </tr>
            <tr>
              <td>3</td>
              <td><input type="text" value="Salones comunes" class="location" /></td>
              <td><input type="text" value="Incandescente" class="oldType" /></td>
              <td><input type="number" value="60" min="0" class="oldPower" /></td>
              <td><input type="number" value="30" min="1" class="oldQty" /></td>
              <td><input type="text" value="LED E27" class="newType" /></td>
              <td><input type="number" value="9" min="0" class="newPower" /></td>
              <td><input type="number" value="30" min="1" class="newQty" /></td>
              <td><button class="btn-remove" onclick="removeRow(this)">Eliminar</button></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="btn-actions">
        <button class="btn btn-secondary" onclick="addRow()">‚ûï A√±adir luminaria</button>
        <button class="btn btn-primary" onclick="calculateSavings()">üîÑ Calcular ahorros</button>
      </div>
    </div>

    <!-- Metodolog√≠a -->
    <div class="card">
      <h2>üìê Metodolog√≠a de C√°lculo (seg√∫n TER030)</h2>
      
      <div class="methodology">
        <p><strong>F√≥rmula oficial:</strong></p>
        <div class="formula">
          AETOTAL = (PAnt - PPos) √ó t
        </div>
        <p>Donde:</p>
        <ul style="margin: 10px 0; padding-left: 25px;">
          <li><strong>PAnt:</strong> Potencia total sistema iluminaci√≥n anterior (kW)</li>
          <li><strong>PPos:</strong> Potencia total sistema iluminaci√≥n posterior (kW)</li>
          <li><strong>t:</strong> Tiempo de utilizaci√≥n anual medio (h) - seg√∫n Anexo II</li>
          <li><strong>AETOTAL:</strong> Ahorro anual energ√≠a final total (kWh/a√±o)</li>
        </ul>
      </div>
    </div>

    <!-- Resumen de resultados -->
    <div class="card">
      <h2>üìä Resumen de Resultados</h2>
      
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-label">Potencia Anterior (PAnt)</div>
          <div class="summary-value"><span id="totalOldPower">0.00</span> <span class="summary-unit">kW</span></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Potencia Posterior (PPos)</div>
          <div class="summary-value"><span id="totalNewPower">0.00</span> <span class="summary-unit">kW</span></div>
        </div>
        <div class="summary-item success">
          <div class="summary-label">Ahorro Energ√©tico Anual (AETOTAL)</div>
          <div class="summary-value"><span id="totalSavings">0</span> <span class="summary-unit">kWh/a√±o</span></div>
        </div>
        <div class="summary-item warning">
          <div class="summary-label">Ahorro Econ√≥mico Anual</div>
          <div class="summary-value"><span id="totalCostSavings">0</span> <span class="summary-unit">‚Ç¨/a√±o</span></div>
        </div>
      </div>

      <div class="summary-grid" style="margin-top: 20px;">
        <div class="summary-item">
          <div class="summary-label">Reducci√≥n Potencia</div>
          <div class="summary-value"><span id="powerReduction">0</span> <span class="summary-unit">%</span></div>
        </div>
        <div class="summary-item success">
          <div class="summary-label">Reducci√≥n Emisiones CO‚ÇÇ</div>
          <div class="summary-value"><span id="co2Reduction">0</span> <span class="summary-unit">kg/a√±o</span></div>
        </div>
        <div class="summary-item warning">
          <div class="summary-label">Ahorro en 10 a√±os</div>
          <div class="summary-value"><span id="savings10years">0</span> <span class="summary-unit">‚Ç¨</span></div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Total Luminarias</div>
          <div class="summary-value"><span id="totalLights">0</span> <span class="summary-unit">uds</span></div>
        </div>
      </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="card">
      <h2>üìà An√°lisis Gr√°fico</h2>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px;">
        <div>
          <h3>Comparativa de Potencia Instalada</h3>
          <div class="chart-container">
            <canvas id="powerChart"></canvas>
          </div>
        </div>
        <div>
          <h3>Ahorro Energ√©tico por Ubicaci√≥n</h3>
          <div class="chart-container">
            <canvas id="savingsChart"></canvas>
          </div>
        </div>
      </div>

      <div style="margin-top: 30px;">
        <h3>Proyecci√≥n de Ahorros Acumulados</h3>
        <div class="chart-container">
          <canvas id="projectionChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Botones de exportaci√≥n -->
    <div class="card">
      <h2>üíæ Exportar Informe</h2>
      <div class="btn-actions">
        <button class="btn btn-export" onclick="exportToPDF()">üìÑ Descargar PDF</button>
        <button class="btn btn-export" onclick="exportToCSV()">üìä Exportar CSV</button>
        <button class="btn btn-export" onclick="exportToExcel()">üìó Exportar Excel</button>
      </div>
    </div>
  </div>

  <script>
    let rowCounter = 3;
    let powerChart, savingsChart, projectionChart;

    // Actualizar horas seg√∫n tipo de edificio
    document.getElementById('buildingType').addEventListener('change', function() {
      const value = this.value;
      const hoursInput = document.getElementById('hoursPerYear');
      
      if (value !== 'custom') {
        const hours = parseInt(value.replace(/[^0-9]/g, ''));
        hoursInput.value = hours;
      }
      
      calculateSavings();
    });

    // Recalcular al cambiar inputs
    document.getElementById('hoursPerYear').addEventListener('input', calculateSavings);
    document.getElementById('electricityPrice').addEventListener('input', calculateSavings);
    document.getElementById('co2Factor').addEventListener('input', calculateSavings);

    function addRow() {
      rowCounter++;
      const tbody = document.getElementById('lightsTableBody');
      const row = tbody.insertRow();
      
      row.innerHTML = `
        <td>${rowCounter}</td>
        <td><input type="text" value="Nueva ubicaci√≥n" class="location" /></td>
        <td><input type="text" value="Fluorescente" class="oldType" /></td>
        <td><input type="number" value="40" min="0" class="oldPower" /></td>
        <td><input type="number" value="10" min="1" class="oldQty" /></td>
        <td><input type="text" value="LED" class="newType" /></td>
        <td><input type="number" value="18" min="0" class="newPower" /></td>
        <td><input type="number" value="10" min="1" class="newQty" /></td>
        <td><button class="btn-remove" onclick="removeRow(this)">Eliminar</button></td>
      `;
      
      // A√±adir listeners a los nuevos inputs
      row.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', calculateSavings);
      });
      
      calculateSavings();
    }

    function removeRow(btn) {
      const row = btn.closest('tr');
      row.remove();
      renumberRows();
      calculateSavings();
    }

    function renumberRows() {
      const rows = document.querySelectorAll('#lightsTableBody tr');
      rows.forEach((row, index) => {
        row.cells[0].textContent = index + 1;
      });
      rowCounter = rows.length;
    }

    function calculateSavings() {
      const rows = document.querySelectorAll('#lightsTableBody tr');
      const hoursPerYear = parseFloat(document.getElementById('hoursPerYear').value) || 0;
      const electricityPrice = parseFloat(document.getElementById('electricityPrice').value) || 0;
      const co2Factor = parseFloat(document.getElementById('co2Factor').value) || 0;
      
      let totalOldPowerW = 0;
      let totalNewPowerW = 0;
      let totalLights = 0;
      const locationData = [];
      
      rows.forEach(row => {
        const location = row.querySelector('.location').value;
        const oldPower = parseFloat(row.querySelector('.oldPower').value) || 0;
        const oldQty = parseInt(row.querySelector('.oldQty').value) || 0;
        const newPower = parseFloat(row.querySelector('.newPower').value) || 0;
        const newQty = parseInt(row.querySelector('.newQty').value) || 0;
        
        const oldTotalW = oldPower * oldQty;
        const newTotalW = newPower * newQty;
        
        totalOldPowerW += oldTotalW;
        totalNewPowerW += newTotalW;
        totalLights += Math.max(oldQty, newQty);
        
        const savingskWh = ((oldTotalW - newTotalW) / 1000) * hoursPerYear;
        
        locationData.push({
          location: location,
          oldPowerW: oldTotalW,
          newPowerW: newTotalW,
          savingskWh: savingskWh
        });
      });
      
      // Convertir a kW (seg√∫n TER030)
      const totalOldPowerKW = totalOldPowerW / 1000;
      const totalNewPowerKW = totalNewPowerW / 1000;
      
      // Calcular ahorro seg√∫n f√≥rmula TER030: AETOTAL = (PAnt - PPos) √ó t
      const totalSavingskWh = (totalOldPowerKW - totalNewPowerKW) * hoursPerYear;
      const totalCostSavings = totalSavingskWh * electricityPrice;
      const powerReduction = totalOldPowerKW > 0 ? ((totalOldPowerKW - totalNewPowerKW) / totalOldPowerKW * 100) : 0;
      const co2Reduction = totalSavingskWh * co2Factor;
      const savings10years = totalCostSavings * 10;
      
      // Actualizar resumen
      document.getElementById('totalOldPower').textContent = totalOldPowerKW.toFixed(2);
      document.getElementById('totalNewPower').textContent = totalNewPowerKW.toFixed(2);
      document.getElementById('totalSavings').textContent = Math.round(totalSavingskWh).toLocaleString();
      document.getElementById('totalCostSavings').textContent = Math.round(totalCostSavings).toLocaleString();
      document.getElementById('powerReduction').textContent = powerReduction.toFixed(1);
      document.getElementById('co2Reduction').textContent = Math.round(co2Reduction).toLocaleString();
      document.getElementById('savings10years').textContent = Math.round(savings10years).toLocaleString();
      document.getElementById('totalLights').textContent = totalLights;
      
      // Actualizar gr√°ficos
      updateCharts(totalOldPowerKW, totalNewPowerKW, locationData, totalCostSavings);
    }

    function updateCharts(oldPower, newPower, locationData, annualSavings) {
      const onaColors = {
        tealDark: '#006B7D',
        teal: '#008B9C',
        tealLight: '#00A8BD',
        success: '#28A745',
        warning: '#FFC107'
      };

      // Gr√°fico de potencia
      const ctxPower = document.getElementById('powerChart').getContext('2d');
      if (powerChart) powerChart.destroy();
      
      powerChart = new Chart(ctxPower, {
        type: 'bar',
        data: {
          labels: ['Potencia Anterior (PAnt)', 'Potencia Posterior (PPos)'],
          datasets: [{
            label: 'Potencia (kW)',
            data: [oldPower, newPower],
            backgroundColor: [onaColors.warning, onaColors.success],
            borderColor: [onaColors.warning, onaColors.success],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Potencia (kW)' }
            }
          }
        }
      });

      // Gr√°fico de ahorros por ubicaci√≥n
      const ctxSavings = document.getElementById('savingsChart').getContext('2d');
      if (savingsChart) savingsChart.destroy();
      
      savingsChart = new Chart(ctxSavings, {
        type: 'doughnut',
        data: {
          labels: locationData.map(d => d.location),
          datasets: [{
            label: 'Ahorro (kWh/a√±o)',
            data: locationData.map(d => d.savingskWh),
            backgroundColor: [
              onaColors.teal,
              onaColors.tealLight,
              onaColors.success,
              '#4CAF50',
              '#66BB6A',
              '#81C784'
            ],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right' }
          }
        }
      });

      // Gr√°fico de proyecci√≥n
      const years = [1, 2, 3, 5, 10, 15, 20];
      const ctxProjection = document.getElementById('projectionChart').getContext('2d');
      if (projectionChart) projectionChart.destroy();
      
      projectionChart = new Chart(ctxProjection, {
        type: 'line',
        data: {
          labels: years.map(y => `A√±o ${y}`),
          datasets: [{
            label: 'Ahorro Acumulado (‚Ç¨)',
            data: years.map(y => annualSavings * y),
            borderColor: onaColors.teal,
            backgroundColor: 'rgba(0, 139, 156, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 5,
            pointHoverRadius: 7
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Ahorro Acumulado (‚Ç¨)' },
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + ' ‚Ç¨';
                }
              }
            }
          }
        }
      });
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // T√≠tulo
      doc.setFontSize(18);
      doc.setTextColor(0, 107, 125);
      doc.text('Informe de Ahorro Energ√©tico', 105, 20, { align: 'center' });
      
      doc.setFontSize(12);
      doc.setTextColor(108, 117, 125);
      doc.text('Sustituci√≥n de Iluminaci√≥n por LED - Ficha TER030', 105, 28, { align: 'center' });
      
      // Fecha
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 20, 40);
      
      // Par√°metros generales
      const buildingType = document.getElementById('buildingType').selectedOptions[0].text;
      const hours = document.getElementById('hoursPerYear').value;
      const price = document.getElementById('electricityPrice').value;
      
      doc.setFontSize(14);
      doc.setTextColor(0, 107, 125);
      doc.text('Par√°metros Generales', 20, 50);
      
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      doc.text(`Tipo de edificio: ${buildingType}`, 20, 58);
      doc.text(`Horas de funcionamiento: ${hours} h/a√±o`, 20, 65);
      doc.text(`Precio electricidad: ${price} ‚Ç¨/kWh`, 20, 72);
      
      // Resultados principales
      doc.setFontSize(14);
      doc.setTextColor(0, 107, 125);
      doc.text('Resultados Principales', 20, 85);
      
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      const oldPower = document.getElementById('totalOldPower').textContent;
      const newPower = document.getElementById('totalNewPower').textContent;
      const savings = document.getElementById('totalSavings').textContent;
      const costSavings = document.getElementById('totalCostSavings').textContent;
      const reduction = document.getElementById('powerReduction').textContent;
      const co2 = document.getElementById('co2Reduction').textContent;
      
      doc.text(`Potencia Anterior (PAnt): ${oldPower} kW`, 20, 93);
      doc.text(`Potencia Posterior (PPos): ${newPower} kW`, 20, 100);
      doc.text(`Ahorro Energ√©tico (AETOTAL): ${savings} kWh/a√±o`, 20, 107);
      doc.text(`Ahorro Econ√≥mico: ${costSavings} ‚Ç¨/a√±o`, 20, 114);
      doc.text(`Reducci√≥n de potencia: ${reduction}%`, 20, 121);
      doc.text(`Reducci√≥n emisiones CO‚ÇÇ: ${co2} kg/a√±o`, 20, 128);
      
      // F√≥rmula
      doc.setFontSize(14);
      doc.setTextColor(0, 107, 125);
      doc.text('Metodolog√≠a (TER030)', 20, 141);
      
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      doc.text('AETOTAL = (PAnt - PPos) √ó t', 20, 149);
      doc.setFontSize(9);
      doc.text('Donde PAnt: Potencia anterior, PPos: Potencia posterior, t: Tiempo uso anual', 20, 156);
      
      // Tabla de luminarias
      doc.setFontSize(14);
      doc.setTextColor(0, 107, 125);
      doc.text('Detalle de Luminarias', 20, 170);
      
      const rows = document.querySelectorAll('#lightsTableBody tr');
      let yPos = 178;
      doc.setFontSize(8);
      
      rows.forEach((row, index) => {
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        
        const location = row.querySelector('.location').value;
        const oldType = row.querySelector('.oldType').value;
        const oldPowerVal = row.querySelector('.oldPower').value;
        const newType = row.querySelector('.newType').value;
        const newPowerVal = row.querySelector('.newPower').value;
        
        doc.text(`${index + 1}. ${location}`, 20, yPos);
        doc.text(`   ${oldType} (${oldPowerVal}W) ‚Üí ${newType} (${newPowerVal}W)`, 20, yPos + 5);
        yPos += 12;
      });
      
      // Guardar
      doc.save('Informe_Ahorro_Iluminacion_LED.pdf');
    }

    function exportToCSV() {
      const rows = document.querySelectorAll('#lightsTableBody tr');
      const hours = document.getElementById('hoursPerYear').value;
      const price = document.getElementById('electricityPrice').value;
      
      let csv = 'Informe de Ahorro Energ√©tico - Iluminaci√≥n LED\n';
      csv += 'Ficha TER030 - Sustituci√≥n por LED\n\n';
      csv += `Fecha:,${new Date().toLocaleDateString('es-ES')}\n`;
      csv += `Horas funcionamiento:,${hours},h/a√±o\n`;
      csv += `Precio electricidad:,${price},‚Ç¨/kWh\n\n`;
      
      csv += 'Ubicaci√≥n,Tipo Anterior,Potencia Ant. (W),Cantidad Ant.,Tipo Nuevo,Potencia LED (W),Cantidad LED,Ahorro (kWh/a√±o)\n';
      
      rows.forEach(row => {
        const location = row.querySelector('.location').value;
        const oldType = row.querySelector('.oldType').value;
        const oldPower = row.querySelector('.oldPower').value;
        const oldQty = row.querySelector('.oldQty').value;
        const newType = row.querySelector('.newType').value;
        const newPower = row.querySelector('.newPower').value;
        const newQty = row.querySelector('.newQty').value;
        
        const oldTotalW = parseFloat(oldPower) * parseInt(oldQty);
        const newTotalW = parseFloat(newPower) * parseInt(newQty);
        const savingskWh = ((oldTotalW - newTotalW) / 1000) * parseFloat(hours);
        
        csv += `"${location}","${oldType}",${oldPower},${oldQty},"${newType}",${newPower},${newQty},${savingskWh.toFixed(2)}\n`;
      });
      
      csv += '\nResumen Total\n';
      csv += `Potencia Anterior (PAnt):,${document.getElementById('totalOldPower').textContent},kW\n`;
      csv += `Potencia Posterior (PPos):,${document.getElementById('totalNewPower').textContent},kW\n`;
      csv += `Ahorro Energ√©tico (AETOTAL):,${document.getElementById('totalSavings').textContent},kWh/a√±o\n`;
      csv += `Ahorro Econ√≥mico:,${document.getElementById('totalCostSavings').textContent},‚Ç¨/a√±o\n`;
      csv += `Reducci√≥n Potencia:,${document.getElementById('powerReduction').textContent},%\n`;
      csv += `Reducci√≥n CO‚ÇÇ:,${document.getElementById('co2Reduction').textContent},kg/a√±o\n`;
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'Ahorro_Iluminacion_LED.csv';
      link.click();
    }

    function exportToExcel() {
      const rows = document.querySelectorAll('#lightsTableBody tr');
      const hours = document.getElementById('hoursPerYear').value;
      const price = document.getElementById('electricityPrice').value;
      
      let html = '<html><head><meta charset="utf-8"><style>table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}th{background-color:#006B7D;color:white;}</style></head><body>';
      html += '<h2>Informe de Ahorro Energ√©tico - Iluminaci√≥n LED</h2>';
      html += '<h3>Ficha TER030 - Sustituci√≥n por LED</h3>';
      html += `<p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-ES')}</p>`;
      html += `<p><strong>Horas funcionamiento:</strong> ${hours} h/a√±o</p>`;
      html += `<p><strong>Precio electricidad:</strong> ${price} ‚Ç¨/kWh</p>`;
      
      html += '<h3>Detalle de Luminarias</h3>';
      html += '<table><thead><tr><th>#</th><th>Ubicaci√≥n</th><th>Tipo Ant.</th><th>Potencia Ant. (W)</th><th>Cant. Ant.</th><th>Tipo LED</th><th>Potencia LED (W)</th><th>Cant. LED</th><th>Ahorro (kWh/a√±o)</th></tr></thead><tbody>';
      
      rows.forEach((row, index) => {
        const location = row.querySelector('.location').value;
        const oldType = row.querySelector('.oldType').value;
        const oldPower = row.querySelector('.oldPower').value;
        const oldQty = row.querySelector('.oldQty').value;
        const newType = row.querySelector('.newType').value;
        const newPower = row.querySelector('.newPower').value;
        const newQty = row.querySelector('.newQty').value;
        
        const oldTotalW = parseFloat(oldPower) * parseInt(oldQty);
        const newTotalW = parseFloat(newPower) * parseInt(newQty);
        const savingskWh = ((oldTotalW - newTotalW) / 1000) * parseFloat(hours);
        
        html += `<tr><td>${index + 1}</td><td>${location}</td><td>${oldType}</td><td>${oldPower}</td><td>${oldQty}</td><td>${newType}</td><td>${newPower}</td><td>${newQty}</td><td>${savingskWh.toFixed(2)}</td></tr>`;
      });
      
      html += '</tbody></table>';
      
      html += '<h3>Resumen Total</h3>';
      html += '<table><tbody>';
      html += `<tr><td><strong>Potencia Anterior (PAnt)</strong></td><td>${document.getElementById('totalOldPower').textContent} kW</td></tr>`;
      html += `<tr><td><strong>Potencia Posterior (PPos)</strong></td><td>${document.getElementById('totalNewPower').textContent} kW</td></tr>`;
      html += `<tr><td><strong>Ahorro Energ√©tico (AETOTAL)</strong></td><td>${document.getElementById('totalSavings').textContent} kWh/a√±o</td></tr>`;
      html += `<tr><td><strong>Ahorro Econ√≥mico</strong></td><td>${document.getElementById('totalCostSavings').textContent} ‚Ç¨/a√±o</td></tr>`;
      html += `<tr><td><strong>Reducci√≥n Potencia</strong></td><td>${document.getElementById('powerReduction').textContent}%</td></tr>`;
      html += `<tr><td><strong>Reducci√≥n CO‚ÇÇ</strong></td><td>${document.getElementById('co2Reduction').textContent} kg/a√±o</td></tr>`;
      html += '</tbody></table>';
      
      html += '</body></html>';
      
      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'Ahorro_Iluminacion_LED.xls';
      link.click();
    }

    // Calcular al cargar
    calculateSavings();
  </script>
</body>
</html>
