<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ona Hotels - C√°lculo Ahorro Climatizaci√≥n (TER040)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Paleta de colores corporativa Ona Hotels */
    :root {
      --ona-teal-dark: #006B7D;
      --ona-teal: #008B9C;
      --ona-teal-light: #00A8BD;
      --ona-teal-lighter: #E0F4F7;
      --ona-white: #FFFFFF;
      --ona-grey-light: #F8F9FA;
      --ona-grey: #E9ECEF;
      --ona-grey-dark: #6C757D;
      --ona-text: #212529;
      --ona-border: #DEE2E6;
      --ona-success: #28A745;
      --ona-warning: #FFC107;
    }

    * { box-sizing: border-box; }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; 
      padding: 0;
      background: linear-gradient(135deg, var(--ona-grey-light) 0%, var(--ona-grey) 100%);
      color: var(--ona-text);
    }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header con logo */
    header { 
      background: var(--ona-white);
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 107, 125, 0.08);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 25px;
      flex-wrap: wrap;
    }

    header .header-content {
      flex: 1;
    }

    header h1 { 
      margin: 0 0 6px 0; 
      font-size: 24px; 
      font-weight: 600;
      color: var(--ona-teal-dark);
      line-height: 1.3;
    }

    header .subtitle {
      font-size: 13px;
      color: var(--ona-grey-dark);
      margin: 0;
      line-height: 1.4;
    }

    header img { 
      height: 55px; 
      border-radius: 6px;
      flex-shrink: 0;
    }

    /* Tarjetas */
    .card { 
      background: var(--ona-white);
      padding: 24px 28px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 107, 125, 0.08);
      border: 1px solid var(--ona-border);
      margin-bottom: 25px;
    }

    .card h2 { 
      margin: 0 0 18px 0; 
      font-size: 18px;
      font-weight: 600;
      color: var(--ona-teal-dark);
      border-bottom: 2px solid var(--ona-teal-light);
      padding-bottom: 8px;
    }

    .card h3 {
      margin: 20px 0 12px 0;
      font-size: 15px;
      font-weight: 600;
      color: var(--ona-teal);
    }

    /* Formulario */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      color: var(--ona-text);
      margin-bottom: 6px;
    }

    label .unit {
      font-weight: 400;
      color: var(--ona-grey-dark);
      font-size: 12px;
    }

    input, select {
      padding: 10px 12px;
      border: 1px solid var(--ona-border);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--ona-teal);
      box-shadow: 0 0 0 3px var(--ona-teal-lighter);
    }

    /* Checkbox para servicios */
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: var(--ona-grey-light);
      padding: 15px;
      border-radius: 6px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-item label {
      margin: 0;
      cursor: pointer;
      font-size: 14px;
    }

    /* Botones */
    .btn {
      padding: 11px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--ona-teal);
      color: white;
    }

    .btn-primary:hover {
      background: var(--ona-teal-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 139, 156, 0.3);
    }

    .btn-secondary {
      background: var(--ona-grey);
      color: var(--ona-text);
    }

    .btn-secondary:hover {
      background: var(--ona-border);
    }

    .btn-export {
      background: var(--ona-success);
      color: white;
    }

    .btn-export:hover {
      background: #218838;
    }

    .btn-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    /* Resumen de resultados */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }

    .summary-item {
      background: linear-gradient(135deg, var(--ona-teal-light) 0%, var(--ona-teal) 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 139, 156, 0.2);
    }

    .summary-item.warning {
      background: linear-gradient(135deg, #FFD54F 0%, var(--ona-warning) 100%);
      color: var(--ona-text);
    }

    .summary-item.success {
      background: linear-gradient(135deg, #66BB6A 0%, var(--ona-success) 100%);
    }

    .summary-label {
      font-size: 12px;
      font-weight: 500;
      opacity: 0.95;
      margin-bottom: 6px;
    }

    .summary-value {
      font-size: 28px;
      font-weight: 700;
      line-height: 1.2;
    }

    .summary-unit {
      font-size: 14px;
      font-weight: 400;
      opacity: 0.9;
    }

    /* Gr√°ficos */
    .chart-container {
      position: relative;
      height: 350px;
      margin: 20px 0;
    }

    /* Metodolog√≠a */
    .methodology {
      background: var(--ona-grey-light);
      padding: 16px 20px;
      border-radius: 8px;
      border-left: 4px solid var(--ona-teal);
      margin: 20px 0;
      font-size: 13px;
      line-height: 1.6;
    }

    .methodology strong {
      color: var(--ona-teal-dark);
    }

    .formula {
      background: white;
      padding: 12px 16px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      margin: 10px 0;
      text-align: center;
      font-size: 14px;
      border: 1px solid var(--ona-border);
    }

    /* Referencias normativas */
    .reference {
      background: var(--ona-teal-lighter);
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 12px;
      margin: 15px 0;
      border-left: 3px solid var(--ona-teal);
    }

    .reference strong {
      color: var(--ona-teal-dark);
    }

    .info-box {
      background: #FFF3CD;
      border-left: 4px solid var(--ona-warning);
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 12px;
      margin: 15px 0;
    }

    /* Tabla de par√°metros */
    table { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 13px;
      margin: 15px 0;
    }

    thead {
      background: var(--ona-teal-dark);
      color: var(--ona-white);
    }

    th { 
      padding: 12px 10px; 
      text-align: left; 
      font-weight: 600;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    td { 
      padding: 10px; 
      border: 1px solid var(--ona-border);
    }

    tbody tr:nth-child(even) {
      background: var(--ona-grey-light);
    }

    tbody tr:hover {
      background: var(--ona-teal-lighter);
    }

    /* Secciones colapsables */
    .collapsible-section {
      margin-bottom: 15px;
    }

    .section-content {
      display: none;
      margin-top: 15px;
    }

    .section-content.active {
      display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        text-align: center;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .summary-grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 11px;
      }

      th, td {
        padding: 8px 6px;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <header>
      <div class="header-content">
        <h1>C√°lculo de Ahorro Energ√©tico - Climatizaci√≥n</h1>
        <p class="subtitle">Ficha TER040: Sustituci√≥n de generador de climatizaci√≥n por bomba de calor | Sector Terciario</p>
      </div>
      <img src="https://agi-prod-file-upload-public-main-use1.s3.amazonaws.com/b806f497-fbe0-4b2d-9354-245962d5b1a4" alt="Ona Hotels" />
    </header>

    <!-- Servicios a calcular -->
    <div class="card">
      <h2>üéØ Servicios Incluidos en el C√°lculo</h2>
      
      <div class="reference">
        <strong>Normativa aplicable:</strong> Ficha TER040 - Sustituci√≥n de generador de climatizaci√≥n por bomba de calor de accionamiento el√©ctrico (Anexos II-V)
      </div>

      <div class="checkbox-group">
        <div class="checkbox-item">
          <input type="checkbox" id="includeHeating" checked onchange="toggleSections()">
          <label for="includeHeating">Calefacci√≥n</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="includeCooling" checked onchange="toggleSections()">
          <label for="includeCooling">Refrigeraci√≥n (Aire Acondicionado)</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="includeACS" onchange="toggleSections()">
          <label for="includeACS">Agua Caliente Sanitaria (ACS)</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="includePool" onchange="toggleSections()">
          <label for="includePool">Calentamiento de Piscina</label>
        </div>
      </div>
    </div>

    <!-- Par√°metros generales -->
    <div class="card">
      <h2>üìã Par√°metros Generales</h2>

      <div class="form-grid">
        <div class="form-group">
          <label for="climateZone">Zona clim√°tica <span class="unit">(seg√∫n CTE)</span></label>
          <select id="climateZone">
            <option value="A3">A3 - Almer√≠a, M√°laga</option>
            <option value="A4">A4 - C√°diz, Sevilla</option>
            <option value="B3">B3 - Castell√≥n, Valencia</option>
            <option value="B4">B4 - Murcia, Alicante</option>
            <option value="C1">C1 - Lugo, Pontevedra</option>
            <option value="C2">C2 - A Coru√±a, Asturias</option>
            <option value="C3" selected>C3 - Tarragona, Barcelona</option>
            <option value="C4">C4 - Badajoz, Huelva</option>
            <option value="D1">D1 - Le√≥n, Palencia</option>
            <option value="D2">D2 - Cantabria, Pa√≠s Vasco</option>
            <option value="D3">D3 - Madrid, Zaragoza</option>
            <option value="E1">E1 - Burgos, Soria</option>
          </select>
        </div>

        <div class="form-group">
          <label for="heatPumpType">Tipo de bomba de calor nueva</label>
          <select id="heatPumpType">
            <option value="aireAgua">Aire-Agua (Aerotermia)</option>
            <option value="aguaAgua">Agua-Agua (Hidrotermia)</option>
            <option value="aireAire">Aire-Aire</option>
            <option value="geoHorizontal">Geotermia circuito cerrado (horizontal)</option>
            <option value="geoVertical">Geotermia circuito cerrado (vertical)</option>
            <option value="geoAbierto">Geotermia circuito abierto</option>
          </select>
        </div>

        <div class="form-group">
          <label for="numEquipments">N√∫mero de equipos a sustituir</label>
          <input type="number" id="numEquipments" value="1" min="1" max="10" step="1" />
        </div>
      </div>
    </div>

    <!-- CALEFACCI√ìN -->
    <div class="card collapsible-section" id="heatingSection">
      <h2>üî• Par√°metros de Calefacci√≥n</h2>

      <div class="form-grid">
        <div class="form-group">
          <label for="heatingPower">Potencia nominal calefacci√≥n <span class="unit">(kW)</span></label>
          <input type="number" id="heatingPower" value="100" min="0" step="1" />
        </div>

        <div class="form-group">
          <label for="scopOld">SCOP equipo existente <span class="unit">(-)</span></label>
          <input type="number" id="scopOld" value="2.5" min="1" max="10" step="0.1" />
        </div>

        <div class="form-group">
          <label for="scopNew">SCOP bomba de calor nueva <span class="unit">(-)</span></label>
          <input type="number" id="scopNew" value="4.0" min="1" max="10" step="0.1" />
        </div>

        <div class="form-group">
          <label for="heatingHours">Horas funcionamiento/a√±o <span class="unit">(h/a√±o)</span></label>
          <input type="number" id="heatingHours" value="1152" min="0" step="100" />
        </div>
      </div>

      <div class="info-box">
        <strong>‚ÑπÔ∏è SCOP:</strong> Coeficiente de rendimiento estacional. Valores t√≠picos - Equipo existente: 2.0-3.0 | Bomba de calor nueva: 3.5-5.5 (seg√∫n tipo y zona clim√°tica)
      </div>
    </div>

    <!-- REFRIGERACI√ìN -->
    <div class="card collapsible-section" id="coolingSection">
      <h2>‚ùÑÔ∏è Par√°metros de Refrigeraci√≥n</h2>

      <div class="form-grid">
        <div class="form-group">
          <label for="coolingPower">Potencia nominal refrigeraci√≥n <span class="unit">(kW)</span></label>
          <input type="number" id="coolingPower" value="90" min="0" step="1" />
        </div>

        <div class="form-group">
          <label for="seerOld">SEER equipo existente <span class="unit">(W/W)</span></label>
          <input type="number" id="seerOld" value="2.8" min="1" max="10" step="0.1" />
        </div>

        <div class="form-group">
          <label for="seerNew">SEER bomba de calor nueva <span class="unit">(W/W)</span></label>
          <input type="number" id="seerNew" value="5.0" min="1" max="10" step="0.1" />
        </div>

        <div class="form-group">
          <label for="coolingHours">Horas funcionamiento/a√±o <span class="unit">(h/a√±o)</span></label>
          <input type="number" id="coolingHours" value="768" min="0" step="100" />
        </div>
      </div>

      <div class="info-box">
        <strong>‚ÑπÔ∏è SEER:</strong> Factor de eficiencia energ√©tica estacional en refrigeraci√≥n. Valores t√≠picos - Equipo existente: 2.5-3.5 | Bomba de calor nueva: 4.5-7.0
      </div>
    </div>

    <!-- ACS -->
    <div class="card collapsible-section" id="acsSection" style="display: none;">
      <h2>üöø Par√°metros de Agua Caliente Sanitaria (ACS)</h2>

      <div class="form-grid">
        <div class="form-group">
          <label for="scopAcsOld">SCOP ACS equipo existente <span class="unit">(-)</span></label>
          <input type="number" id="scopAcsOld" value="2.0" min="1" max="10" step="0.1" />
        </div>

        <div class="form-group">
          <label for="scopAcsNew">SCOP ACS bomba de calor nueva <span class="unit">(-)</span></label>
          <input type="number" id="scopAcsNew" value="3.5" min="1" max="10" step="0.1" />
        </div>

        <div class="form-group">
          <label for="acsDemand">Demanda anual ACS <span class="unit">(kWh/a√±o)</span></label>
          <input type="number" id="acsDemand" value="50000" min="0" step="1000" />
        </div>

        <div class="form-group">
          <label for="acsFactor">Factor de ponderaci√≥n (Fp) <span class="unit">(-)</span></label>
          <input type="number" id="acsFactor" value="1.0" min="0.5" max="1.5" step="0.1" />
        </div>
      </div>
    </div>

    <!-- PISCINA -->
    <div class="card collapsible-section" id="poolSection" style="display: none;">
      <h2>üèä Par√°metros de Calentamiento de Piscina</h2>

      <div class="form-grid">
        <div class="form-group">
          <label for="scopPoolOld">SCOP piscina equipo existente <span class="unit">(-)</span></label>
          <input type="number" id="scopPoolOld" value="2.5" min="1" max="10" step="0.1" />
        </div>

        <div class="form-group">
          <label for="scopPoolNew">SCOP piscina bomba de calor nueva <span class="unit">(-)</span></label>
          <input type="number" id="scopPoolNew" value="5.0" min="1" max="10" step="0.1" />
        </div>

        <div class="form-group">
          <label for="poolDemand">Demanda anual piscina <span class="unit">(kWh/a√±o)</span></label>
          <input type="number" id="poolDemand" value="100000" min="0" step="5000" />
        </div>

        <div class="form-group">
          <label for="poolFactor">Factor de ponderaci√≥n (Fp) <span class="unit">(-)</span></label>
          <input type="number" id="poolFactor" value="1.0" min="0.5" max="1.5" step="0.1" />
        </div>
      </div>
    </div>

    <!-- Par√°metros econ√≥micos -->
    <div class="card">
      <h2>üí∞ Par√°metros Econ√≥micos</h2>

      <div class="form-grid">
        <div class="form-group">
          <label for="electricityPrice">Precio electricidad <span class="unit">(‚Ç¨/kWh)</span></label>
          <input type="number" id="electricityPrice" value="0.15" min="0" step="0.01" />
        </div>

        <div class="form-group">
          <label for="co2Factor">Factor emisi√≥n CO‚ÇÇ electricidad <span class="unit">(kg CO‚ÇÇ/kWh)</span></label>
          <input type="number" id="co2Factor" value="0.30" min="0" step="0.01" />
        </div>
      </div>

      <div class="btn-actions">
        <button class="btn btn-primary" onclick="calculateSavings()">üîÑ Calcular ahorros</button>
      </div>
    </div>

    <!-- Metodolog√≠a -->
    <div class="card">
      <h2>üìê Metodolog√≠a de C√°lculo (seg√∫n TER040)</h2>
      
      <div class="methodology">
        <p><strong>Calefacci√≥n:</strong></p>
        <div class="formula">
          AEC = Œ£ [Pci √ó (1/SCOPsi - 1/SCOPni) √ó hci]
        </div>
        
        <p><strong>Refrigeraci√≥n:</strong></p>
        <div class="formula">
          AER = Œ£ [PFi √ó (1/SEERsi - 1/SEERni) √ó hRi]
        </div>
        
        <p><strong>ACS:</strong></p>
        <div class="formula">
          AEACS = (1/SCOPsdhw - 1/SCOPdhw) √ó DACS √ó FP
        </div>
        
        <p><strong>Piscina:</strong></p>
        <div class="formula">
          AECAP = (1/SCOPspwh - 1/SCOPnpwh) √ó DCAP √ó FP
        </div>
        
        <p><strong>Ahorro Total:</strong></p>
        <div class="formula">
          AETOTAL = AEC + AER + AEACS + AECAP
        </div>
        
        <p>Donde:</p>
        <ul style="margin: 10px 0; padding-left: 25px;">
          <li><strong>Pci/PFi:</strong> Potencia nominal del equipo sustituido (kW)</li>
          <li><strong>SCOPsi/SEERsi:</strong> Rendimiento estacional equipo existente</li>
          <li><strong>SCOPni/SEERni:</strong> Rendimiento estacional bomba de calor nueva</li>
          <li><strong>hci/hRi:</strong> Horas de funcionamiento anuales a potencia nominal</li>
          <li><strong>DACS/DCAP:</strong> Demanda anual de energ√≠a (kWh/a√±o)</li>
          <li><strong>FP:</strong> Factor de ponderaci√≥n</li>
        </ul>
      </div>
    </div>

    <!-- Resumen de resultados -->
    <div class="card">
      <h2>üìä Resumen de Resultados</h2>
      
      <div class="summary-grid">
        <div class="summary-item success" id="heatingResult">
          <div class="summary-label">Ahorro Calefacci√≥n (AEC)</div>
          <div class="summary-value"><span id="savingsHeating">0</span> <span class="summary-unit">kWh/a√±o</span></div>
        </div>
        <div class="summary-item success" id="coolingResult">
          <div class="summary-label">Ahorro Refrigeraci√≥n (AER)</div>
          <div class="summary-value"><span id="savingsCooling">0</span> <span class="summary-unit">kWh/a√±o</span></div>
        </div>
        <div class="summary-item success" id="acsResult" style="display: none;">
          <div class="summary-label">Ahorro ACS (AEACS)</div>
          <div class="summary-value"><span id="savingsACS">0</span> <span class="summary-unit">kWh/a√±o</span></div>
        </div>
        <div class="summary-item success" id="poolResult" style="display: none;">
          <div class="summary-label">Ahorro Piscina (AECAP)</div>
          <div class="summary-value"><span id="savingsPool">0</span> <span class="summary-unit">kWh/a√±o</span></div>
        </div>
      </div>

      <div class="summary-grid" style="margin-top: 20px;">
        <div class="summary-item">
          <div class="summary-label">Ahorro Energ√©tico Total (AETOTAL)</div>
          <div class="summary-value"><span id="savingsTotal">0</span> <span class="summary-unit">kWh/a√±o</span></div>
        </div>
        <div class="summary-item warning">
          <div class="summary-label">Ahorro Econ√≥mico Anual</div>
          <div class="summary-value"><span id="costSavings">0</span> <span class="summary-unit">‚Ç¨/a√±o</span></div>
        </div>
        <div class="summary-item success">
          <div class="summary-label">Reducci√≥n Emisiones CO‚ÇÇ</div>
          <div class="summary-value"><span id="co2Reduction">0</span> <span class="summary-unit">kg/a√±o</span></div>
        </div>
        <div class="summary-item warning">
          <div class="summary-label">Ahorro 10 a√±os</div>
          <div class="summary-value"><span id="savings10years">0</span> <span class="summary-unit">‚Ç¨</span></div>
        </div>
      </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="card">
      <h2>üìà An√°lisis Gr√°fico</h2>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px;">
        <div>
          <h3>Distribuci√≥n de Ahorros por Servicio</h3>
          <div class="chart-container">
            <canvas id="savingsDistChart"></canvas>
          </div>
        </div>
        <div>
          <h3>Comparativa de Eficiencia</h3>
          <div class="chart-container">
            <canvas id="efficiencyChart"></canvas>
          </div>
        </div>
      </div>

      <div style="margin-top: 30px;">
        <h3>Proyecci√≥n de Ahorros Acumulados</h3>
        <div class="chart-container">
          <canvas id="projectionChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Tabla de an√°lisis detallado -->
    <div class="card">
      <h2>üìã An√°lisis Detallado por Servicio</h2>
      
      <table>
        <thead>
          <tr>
            <th>Servicio</th>
            <th>Potencia/Demanda</th>
            <th>Rendimiento Anterior</th>
            <th>Rendimiento Nuevo</th>
            <th>Horas/A√±o</th>
            <th>Ahorro (kWh/a√±o)</th>
          </tr>
        </thead>
        <tbody id="detailTable">
          <!-- Se llenar√° din√°micamente -->
        </tbody>
      </table>
    </div>

    <!-- Botones de exportaci√≥n -->
    <div class="card">
      <h2>üíæ Exportar Informe</h2>
      <div class="btn-actions">
        <button class="btn btn-export" onclick="exportToPDF()">üìÑ Descargar PDF</button>
        <button class="btn btn-export" onclick="exportToCSV()">üìä Exportar CSV</button>
      </div>
    </div>
  </div>

  <script>
    let savingsDistChart, efficiencyChart, projectionChart;

    function toggleSections() {
      const includeHeating = document.getElementById('includeHeating').checked;
      const includeCooling = document.getElementById('includeCooling').checked;
      const includeACS = document.getElementById('includeACS').checked;
      const includePool = document.getElementById('includePool').checked;

      document.getElementById('heatingSection').style.display = includeHeating ? 'block' : 'none';
      document.getElementById('coolingSection').style.display = includeCooling ? 'block' : 'none';
      document.getElementById('acsSection').style.display = includeACS ? 'block' : 'none';
      document.getElementById('poolSection').style.display = includePool ? 'block' : 'none';

      document.getElementById('heatingResult').style.display = includeHeating ? 'block' : 'none';
      document.getElementById('coolingResult').style.display = includeCooling ? 'block' : 'none';
      document.getElementById('acsResult').style.display = includeACS ? 'block' : 'none';
      document.getElementById('poolResult').style.display = includePool ? 'block' : 'none';

      calculateSavings();
    }

    // Recalcular al cambiar inputs
    const inputs = [
      'numEquipments', 'heatingPower', 'scopOld', 'scopNew', 'heatingHours',
      'coolingPower', 'seerOld', 'seerNew', 'coolingHours',
      'scopAcsOld', 'scopAcsNew', 'acsDemand', 'acsFactor',
      'scopPoolOld', 'scopPoolNew', 'poolDemand', 'poolFactor',
      'electricityPrice', 'co2Factor'
    ];
    
    inputs.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('input', calculateSavings);
      }
    });

    document.getElementById('climateZone').addEventListener('change', calculateSavings);
    document.getElementById('heatPumpType').addEventListener('change', calculateSavings);

    function calculateSavings() {
      const includeHeating = document.getElementById('includeHeating').checked;
      const includeCooling = document.getElementById('includeCooling').checked;
      const includeACS = document.getElementById('includeACS').checked;
      const includePool = document.getElementById('includePool').checked;

      const numEquipments = parseFloat(document.getElementById('numEquipments').value) || 1;
      const electricityPrice = parseFloat(document.getElementById('electricityPrice').value) || 0.15;
      const co2Factor = parseFloat(document.getElementById('co2Factor').value) || 0.30;

      let savingsHeating = 0;
      let savingsCooling = 0;
      let savingsACS = 0;
      let savingsPool = 0;

      // C√ÅLCULOS SEG√öN TER040

      // 1. CALEFACCI√ìN
      if (includeHeating) {
        const heatingPower = parseFloat(document.getElementById('heatingPower').value) || 0;
        const scopOld = parseFloat(document.getElementById('scopOld').value) || 2.5;
        const scopNew = parseFloat(document.getElementById('scopNew').value) || 4.0;
        const heatingHours = parseFloat(document.getElementById('heatingHours').value) || 1152;

        // AEC = Œ£ [Pci √ó (1/SCOPsi - 1/SCOPni) √ó hci]
        savingsHeating = numEquipments * heatingPower * (1/scopOld - 1/scopNew) * heatingHours;
      }

      // 2. REFRIGERACI√ìN
      if (includeCooling) {
        const coolingPower = parseFloat(document.getElementById('coolingPower').value) || 0;
        const seerOld = parseFloat(document.getElementById('seerOld').value) || 2.8;
        const seerNew = parseFloat(document.getElementById('seerNew').value) || 5.0;
        const coolingHours = parseFloat(document.getElementById('coolingHours').value) || 768;

        // AER = Œ£ [PFi √ó (1/SEERsi - 1/SEERni) √ó hRi]
        savingsCooling = numEquipments * coolingPower * (1/seerOld - 1/seerNew) * coolingHours;
      }

      // 3. ACS
      if (includeACS) {
        const scopAcsOld = parseFloat(document.getElementById('scopAcsOld').value) || 2.0;
        const scopAcsNew = parseFloat(document.getElementById('scopAcsNew').value) || 3.5;
        const acsDemand = parseFloat(document.getElementById('acsDemand').value) || 0;
        const acsFactor = parseFloat(document.getElementById('acsFactor').value) || 1.0;

        // AEACS = (1/SCOPsdhw - 1/SCOPdhw) √ó DACS √ó FP
        savingsACS = (1/scopAcsOld - 1/scopAcsNew) * acsDemand * acsFactor;
      }

      // 4. PISCINA
      if (includePool) {
        const scopPoolOld = parseFloat(document.getElementById('scopPoolOld').value) || 2.5;
        const scopPoolNew = parseFloat(document.getElementById('scopPoolNew').value) || 5.0;
        const poolDemand = parseFloat(document.getElementById('poolDemand').value) || 0;
        const poolFactor = parseFloat(document.getElementById('poolFactor').value) || 1.0;

        // AECAP = (1/SCOPspwh - 1/SCOPnpwh) √ó DCAP √ó FP
        savingsPool = (1/scopPoolOld - 1/scopPoolNew) * poolDemand * poolFactor;
      }

      // 5. TOTALES
      const savingsTotal = savingsHeating + savingsCooling + savingsACS + savingsPool;
      const costSavings = savingsTotal * electricityPrice;
      const co2Reduction = savingsTotal * co2Factor;
      const savings10years = costSavings * 10;

      // Actualizar resumen
      document.getElementById('savingsHeating').textContent = Math.round(savingsHeating).toLocaleString();
      document.getElementById('savingsCooling').textContent = Math.round(savingsCooling).toLocaleString();
      document.getElementById('savingsACS').textContent = Math.round(savingsACS).toLocaleString();
      document.getElementById('savingsPool').textContent = Math.round(savingsPool).toLocaleString();
      document.getElementById('savingsTotal').textContent = Math.round(savingsTotal).toLocaleString();
      document.getElementById('costSavings').textContent = Math.round(costSavings).toLocaleString();
      document.getElementById('co2Reduction').textContent = Math.round(co2Reduction).toLocaleString();
      document.getElementById('savings10years').textContent = Math.round(savings10years).toLocaleString();

      // Actualizar tabla detallada
      updateDetailTable(includeHeating, includeCooling, includeACS, includePool, savingsHeating, savingsCooling, savingsACS, savingsPool);

      // Actualizar gr√°ficos
      updateCharts(savingsHeating, savingsCooling, savingsACS, savingsPool, costSavings);
    }

    function updateDetailTable(includeHeating, includeCooling, includeACS, includePool, savingsHeating, savingsCooling, savingsACS, savingsPool) {
      const tbody = document.getElementById('detailTable');
      tbody.innerHTML = '';

      if (includeHeating) {
        const heatingPower = parseFloat(document.getElementById('heatingPower').value) || 0;
        const scopOld = parseFloat(document.getElementById('scopOld').value) || 2.5;
        const scopNew = parseFloat(document.getElementById('scopNew').value) || 4.0;
        const heatingHours = parseFloat(document.getElementById('heatingHours').value) || 1152;

        const row = tbody.insertRow();
        row.innerHTML = `
          <td><strong>Calefacci√≥n</strong></td>
          <td>${heatingPower.toFixed(1)} kW</td>
          <td>SCOP: ${scopOld.toFixed(2)}</td>
          <td>SCOP: ${scopNew.toFixed(2)}</td>
          <td>${heatingHours.toLocaleString()} h</td>
          <td><strong>${Math.round(savingsHeating).toLocaleString()} kWh</strong></td>
        `;
      }

      if (includeCooling) {
        const coolingPower = parseFloat(document.getElementById('coolingPower').value) || 0;
        const seerOld = parseFloat(document.getElementById('seerOld').value) || 2.8;
        const seerNew = parseFloat(document.getElementById('seerNew').value) || 5.0;
        const coolingHours = parseFloat(document.getElementById('coolingHours').value) || 768;

        const row = tbody.insertRow();
        row.innerHTML = `
          <td><strong>Refrigeraci√≥n</strong></td>
          <td>${coolingPower.toFixed(1)} kW</td>
          <td>SEER: ${seerOld.toFixed(2)}</td>
          <td>SEER: ${seerNew.toFixed(2)}</td>
          <td>${coolingHours.toLocaleString()} h</td>
          <td><strong>${Math.round(savingsCooling).toLocaleString()} kWh</strong></td>
        `;
      }

      if (includeACS) {
        const acsDemand = parseFloat(document.getElementById('acsDemand').value) || 0;
        const scopAcsOld = parseFloat(document.getElementById('scopAcsOld').value) || 2.0;
        const scopAcsNew = parseFloat(document.getElementById('scopAcsNew').value) || 3.5;

        const row = tbody.insertRow();
        row.innerHTML = `
          <td><strong>ACS</strong></td>
          <td>${(acsDemand/1000).toFixed(1)} MWh/a√±o</td>
          <td>SCOP: ${scopAcsOld.toFixed(2)}</td>
          <td>SCOP: ${scopAcsNew.toFixed(2)}</td>
          <td>-</td>
          <td><strong>${Math.round(savingsACS).toLocaleString()} kWh</strong></td>
        `;
      }

      if (includePool) {
        const poolDemand = parseFloat(document.getElementById('poolDemand').value) || 0;
        const scopPoolOld = parseFloat(document.getElementById('scopPoolOld').value) || 2.5;
        const scopPoolNew = parseFloat(document.getElementById('scopPoolNew').value) || 5.0;

        const row = tbody.insertRow();
        row.innerHTML = `
          <td><strong>Piscina</strong></td>
          <td>${(poolDemand/1000).toFixed(1)} MWh/a√±o</td>
          <td>SCOP: ${scopPoolOld.toFixed(2)}</td>
          <td>SCOP: ${scopPoolNew.toFixed(2)}</td>
          <td>-</td>
          <td><strong>${Math.round(savingsPool).toLocaleString()} kWh</strong></td>
        `;
      }
    }

    function updateCharts(savingsHeating, savingsCooling, savingsACS, savingsPool, annualSavings) {
      const onaColors = {
        tealDark: '#006B7D',
        teal: '#008B9C',
        tealLight: '#00A8BD',
        success: '#28A745',
        warning: '#FFC107'
      };

      const includeHeating = document.getElementById('includeHeating').checked;
      const includeCooling = document.getElementById('includeCooling').checked;
      const includeACS = document.getElementById('includeACS').checked;
      const includePool = document.getElementById('includePool').checked;

      // Gr√°fico de distribuci√≥n de ahorros
      const ctxDist = document.getElementById('savingsDistChart').getContext('2d');
      if (savingsDistChart) savingsDistChart.destroy();

      const labels = [];
      const data = [];
      const colors = [];

      if (includeHeating && savingsHeating > 0) {
        labels.push('Calefacci√≥n');
        data.push(savingsHeating);
        colors.push('#FF6B6B');
      }
      if (includeCooling && savingsCooling > 0) {
        labels.push('Refrigeraci√≥n');
        data.push(savingsCooling);
        colors.push('#4ECDC4');
      }
      if (includeACS && savingsACS > 0) {
        labels.push('ACS');
        data.push(savingsACS);
        colors.push('#45B7D1');
      }
      if (includePool && savingsPool > 0) {
        labels.push('Piscina');
        data.push(savingsPool);
        colors.push('#96CEB4');
      }

      savingsDistChart = new Chart(ctxDist, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return context.label + ': ' + Math.round(value).toLocaleString() + ' kWh (' + percentage + '%)';
                }
              }
            }
          }
        }
      });

      // Gr√°fico de comparativa de eficiencia
      const ctxEff = document.getElementById('efficiencyChart').getContext('2d');
      if (efficiencyChart) efficiencyChart.destroy();

      const effLabels = [];
      const effOld = [];
      const effNew = [];

      if (includeHeating) {
        effLabels.push('Calefacci√≥n (SCOP)');
        effOld.push(parseFloat(document.getElementById('scopOld').value) || 0);
        effNew.push(parseFloat(document.getElementById('scopNew').value) || 0);
      }
      if (includeCooling) {
        effLabels.push('Refrigeraci√≥n (SEER)');
        effOld.push(parseFloat(document.getElementById('seerOld').value) || 0);
        effNew.push(parseFloat(document.getElementById('seerNew').value) || 0);
      }
      if (includeACS) {
        effLabels.push('ACS (SCOP)');
        effOld.push(parseFloat(document.getElementById('scopAcsOld').value) || 0);
        effNew.push(parseFloat(document.getElementById('scopAcsNew').value) || 0);
      }
      if (includePool) {
        effLabels.push('Piscina (SCOP)');
        effOld.push(parseFloat(document.getElementById('scopPoolOld').value) || 0);
        effNew.push(parseFloat(document.getElementById('scopPoolNew').value) || 0);
      }

      efficiencyChart = new Chart(ctxEff, {
        type: 'bar',
        data: {
          labels: effLabels,
          datasets: [
            {
              label: 'Equipo Existente',
              data: effOld,
              backgroundColor: onaColors.warning,
              borderColor: onaColors.warning,
              borderWidth: 2
            },
            {
              label: 'Bomba de Calor Nueva',
              data: effNew,
              backgroundColor: onaColors.success,
              borderColor: onaColors.success,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'top' }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Rendimiento Estacional' }
            }
          }
        }
      });

      // Gr√°fico de proyecci√≥n
      const years = [1, 2, 3, 5, 10, 15, 20];
      const ctxProjection = document.getElementById('projectionChart').getContext('2d');
      if (projectionChart) projectionChart.destroy();
      
      projectionChart = new Chart(ctxProjection, {
        type: 'line',
        data: {
          labels: years.map(y => `A√±o ${y}`),
          datasets: [{
            label: 'Ahorro Acumulado (‚Ç¨)',
            data: years.map(y => annualSavings * y),
            borderColor: onaColors.teal,
            backgroundColor: 'rgba(0, 139, 156, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 5,
            pointHoverRadius: 7
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Ahorro Acumulado (‚Ç¨)' },
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + ' ‚Ç¨';
                }
              }
            }
          }
        }
      });
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // T√≠tulo
      doc.setFontSize(18);
      doc.setTextColor(0, 107, 125);
      doc.text('Informe de Ahorro Energ√©tico', 105, 20, { align: 'center' });
      
      doc.setFontSize(12);
      doc.setTextColor(108, 117, 125);
      doc.text('Sustituci√≥n por Bomba de Calor - Ficha TER040', 105, 28, { align: 'center' });
      
      // Fecha
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 20, 40);
      
      // Servicios incluidos
      doc.setFontSize(14);
      doc.setTextColor(0, 107, 125);
      doc.text('Servicios Calculados', 20, 50);
      
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      let yPos = 58;
      
      if (document.getElementById('includeHeating').checked) {
        doc.text('‚úì Calefacci√≥n', 20, yPos);
        yPos += 7;
      }
      if (document.getElementById('includeCooling').checked) {
        doc.text('‚úì Refrigeraci√≥n', 20, yPos);
        yPos += 7;
      }
      if (document.getElementById('includeACS').checked) {
        doc.text('‚úì ACS', 20, yPos);
        yPos += 7;
      }
      if (document.getElementById('includePool').checked) {
        doc.text('‚úì Piscina', 20, yPos);
        yPos += 7;
      }
      
      yPos += 8;
      
      // Resultados
      doc.setFontSize(14);
      doc.setTextColor(0, 107, 125);
      doc.text('Resultados Principales', 20, yPos);
      
      yPos += 8;
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      
      const savingsTotal = document.getElementById('savingsTotal').textContent;
      const costSavings = document.getElementById('costSavings').textContent;
      const co2Reduction = document.getElementById('co2Reduction').textContent;
      
      if (document.getElementById('includeHeating').checked) {
        const savingsHeating = document.getElementById('savingsHeating').textContent;
        doc.text(`Ahorro Calefacci√≥n: ${savingsHeating} kWh/a√±o`, 20, yPos);
        yPos += 7;
      }
      if (document.getElementById('includeCooling').checked) {
        const savingsCooling = document.getElementById('savingsCooling').textContent;
        doc.text(`Ahorro Refrigeraci√≥n: ${savingsCooling} kWh/a√±o`, 20, yPos);
        yPos += 7;
      }
      if (document.getElementById('includeACS').checked) {
        const savingsACS = document.getElementById('savingsACS').textContent;
        doc.text(`Ahorro ACS: ${savingsACS} kWh/a√±o`, 20, yPos);
        yPos += 7;
      }
      if (document.getElementById('includePool').checked) {
        const savingsPool = document.getElementById('savingsPool').textContent;
        doc.text(`Ahorro Piscina: ${savingsPool} kWh/a√±o`, 20, yPos);
        yPos += 7;
      }
      
      yPos += 3;
      doc.setFontSize(11);
      doc.setFont(undefined, 'bold');
      doc.text(`Ahorro Total: ${savingsTotal} kWh/a√±o`, 20, yPos);
      yPos += 7;
      doc.setFont(undefined, 'normal');
      doc.setFontSize(10);
      doc.text(`Ahorro econ√≥mico: ${costSavings} ‚Ç¨/a√±o`, 20, yPos);
      yPos += 7;
      doc.text(`Reducci√≥n CO‚ÇÇ: ${co2Reduction} kg/a√±o`, 20, yPos);
      
      // Guardar
      doc.save('Informe_Ahorro_Climatizacion.pdf');
    }

    function exportToCSV() {
      let csv = 'Informe de Ahorro Energ√©tico - Climatizaci√≥n\n';
      csv += 'Ficha TER040 - Sustituci√≥n por Bomba de Calor\n\n';
      csv += `Fecha:,${new Date().toLocaleDateString('es-ES')}\n\n`;
      
      csv += 'SERVICIOS CALCULADOS\n';
      if (document.getElementById('includeHeating').checked) csv += 'Calefacci√≥n,S√≠\n';
      if (document.getElementById('includeCooling').checked) csv += 'Refrigeraci√≥n,S√≠\n';
      if (document.getElementById('includeACS').checked) csv += 'ACS,S√≠\n';
      if (document.getElementById('includePool').checked) csv += 'Piscina,S√≠\n';
      csv += '\n';
      
      csv += 'RESULTADOS\n';
      csv += `Ahorro Total (kWh/a√±o):,${document.getElementById('savingsTotal').textContent}\n`;
      csv += `Ahorro Calefacci√≥n (kWh/a√±o):,${document.getElementById('savingsHeating').textContent}\n`;
      csv += `Ahorro Refrigeraci√≥n (kWh/a√±o):,${document.getElementById('savingsCooling').textContent}\n`;
      csv += `Ahorro ACS (kWh/a√±o):,${document.getElementById('savingsACS').textContent}\n`;
      csv += `Ahorro Piscina (kWh/a√±o):,${document.getElementById('savingsPool').textContent}\n`;
      csv += `Ahorro Econ√≥mico (‚Ç¨/a√±o):,${document.getElementById('costSavings').textContent}\n`;
      csv += `Reducci√≥n CO‚ÇÇ (kg/a√±o):,${document.getElementById('co2Reduction').textContent}\n`;
      csv += `Ahorro 10 a√±os (‚Ç¨):,${document.getElementById('savings10years').textContent}\n`;
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'Ahorro_Climatizacion.csv';
      link.click();
    }

    // Calcular al cargar
    calculateSavings();
  </script>
</body>
</html>
